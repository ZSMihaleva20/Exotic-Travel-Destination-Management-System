<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml" lang="bg">
<head>
  <title>Екзотични туристически дестинации</title>
  <meta charset="UTF-8">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
  <link rel="stylesheet" href="/css/destinationsPageStyle.css">
</head>
<body class="bg-gray-100 text-gray-800 pt-20 opacity-0 transition-opacity duration-700 ease-out">

<!-- Main Layout -->
<nav class="fixed top-0 w-full bg-white shadow-md backdrop-blur-md z-50">
  <div class="container mx-auto flex items-center justify-between py-4 px-6">

    <!-- Left Side: Logo -->
    <h2 class="text-3xl font-extrabold text-yellow-500"><a href="/">Exotico</a></h2>

    <!-- Center: Navigation Links -->
    <div class="hidden md:flex space-x-8 mx-auto">
      <a href="/destinations" class="text-lg font-semibold text-gray-700 hover:text-yellow-500 transition"> Дестинации</a>
      <a href="/promotionsAndCampaigns" class="text-lg font-semibold text-gray-700 hover:text-yellow-500 transition">Промоции</a>
      <a href="/statistics" class="text-lg font-semibold text-gray-700 hover:text-yellow-500 transition"> Статистики</a>
    </div>

    <!-- Right Side: User Menu -->
    <div class="relative">
      <div class="bg-gray-800 text-white px-6 py-2 rounded-lg cursor-pointer flex items-center gap-2" id="userMenu">
        <span class="material-symbols-outlined">person</span>
        <span class="font-semibold">Моят акаунт</span>
      </div>

      <!-- Dropdown Menu -->
      <div id="dropdownMenu" class="absolute right-0 mt-2 bg-white text-gray-900 p-4 rounded shadow-md w-48 hidden transition">
        <a href="/profile" class="block py-2">Профил</a>

        <th:block th:if="${#strings.equals(user.role, 'ADMIN') or #strings.equals(user.role, 'MANAGER')}">
          <a href="/destinationManagement" class="block py-2">Управлявай дестинации</a>
          <a href="/ratingManagement" class="block py-2">Управлявай рейтинги</a>
          <a href="/reservationManagement" class="block py-2"> Управлявай резервации</a>
        </th:block>

        <th:block th:if="${#strings.equals(user.role, 'ADMIN')}">
          <a href="/profilesManagement" class="block py-2">Управлявай профили</a>
        </th:block>

        <th:block th:if="${#strings.equals(user.role, 'USER')}">
          <a href="/myReservations" class="block py-2">Моите резервации</a>
          <a href="/rateDestination" class="block py-2"> Добави рейтинг</a>
        </th:block>

        <a href="/logout" class="block py-2 text-red-500">Изход</a>
      </div>
    </div>
  </div>
</nav>
<!-- Main Layout Container (Centers Content & Limits Width) -->
<!-- Main Layout Container (Increased Width) -->
<div class="container max-w-7xl mx-auto px-4 md:px-6">
  <h1 class="text-4xl font-bold text-gray-800 mb-6 text-center">Дестинации</h1>

  <!-- Search & Filter Form (Centered & Compact) -->
  <form action="/destinations" method="get" class="bg-white p-6 rounded-lg shadow-md mb-6">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">

      <!-- Search Keyword -->
      <div class="flex items-center gap-2">
        <label for="dateOfDeparture" class="text-sm font-medium text-gray-600 whitespace-nowrap">Търсене:</label>
        <input type="text" name="keyword" placeholder="Ключова дума..." class="input-field w-full" th:value="${keyword}">
      </div>

      <!-- Departure Date -->
      <div class="flex items-center gap-2">
        <label for="dateOfDeparture" class="text-sm font-medium text-gray-600 whitespace-nowrap">Заминаване:</label>
        <input type="date" id="dateOfDeparture" name="dateOfDeparture" class="input-field w-full" th:value="${dateOfDeparture}">
      </div>

      <!-- Return Date -->
      <div class="flex items-center gap-2">
        <label for="dateOfReturn" class="text-sm font-medium text-gray-600 whitespace-nowrap">Връщане:</label>
        <input type="date" id="dateOfReturn" name="dateOfReturn" class="input-field w-full" th:value="${dateOfReturn}">
      </div>

      <!-- Minimum Price -->
      <div class="flex items-center gap-2">
        <label for="dateOfDeparture" class="text-sm font-medium text-gray-600 whitespace-nowrap">Минимална цена:</label>
        <input type="number" name="minPrice" placeholder="Мин. цена" class="input-field w-full" th:value="${minPrice}">
      </div>

      <!-- Maximum Price -->
      <div class="flex items-center gap-2">
        <label for="dateOfDeparture" class="text-sm font-medium text-gray-600 whitespace-nowrap">Максимална цена:</label>
        <input type="number" name="maxPrice" placeholder="Макс. цена" class="input-field w-full" th:value="${maxPrice}">
      </div>

      <!-- Minimum Rating -->
      <div class="flex items-center gap-2">
        <label for="dateOfDeparture" class="text-sm font-medium text-gray-600 whitespace-nowrap">Минимален рейтинг:</label>
        <input type="number" name="minRating" min="0" max="5" step="0.1" placeholder="Мин. рейтинг" class="input-field w-full" th:value="${minRating}">
      </div>

      <!-- Sort Options -->
      <div class="col-span-3 flex justify-center items-center mt-4">
        <label for="sortOptions" class="text-sm font-medium text-gray-600 mr-2">Сортирай по:</label>
        <select id="sortOptions" name="sortBy" class="input-field w-48 text-left">
          <option value="none" th:selected="${currentSort == 'none'}">Всички</option>
          <option value="price" th:selected="${currentSort == 'price'}">Цена</option>
          <option value="popularity" th:selected="${currentSort == 'popularity'}">Популярност</option>
          <option value="rating" th:selected="${currentSort == 'rating'}">Рейтинг</option>
        </select>
      </div>
    </div>

    <!-- Submit Button -->
    <button type="submit" class="btn btn-primary mt-4 w-full">Филтрирай и сортирай</button>
  </form>

  <!-- Destination Cards (Centered & Limited Width) -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    <th:block th:each="destination : ${acceptedDestinations}">
      <th:block th:if="${!destination.isOnPromotion}">
        <div class="bg-white p-6 rounded-lg shadow-md flex flex-col min-h-full border-2 border-black-500">

          <!-- Destination Name -->
          <h2 class="text-xl font-bold text-gray-700" th:text="${destination.name}"></h2>

          <!-- Destination Description -->
          <ul class="text-gray-600 mt-2 list-disc pl-5 flex-grow"
              th:utext="${#strings.listJoin(#strings.arraySplit(destination.description, '\\;'), '</li><li>')}">
          </ul>

          <!-- Dates -->
          <p class="text-black-600 font-bold mt-2">Дата на заминаване:
            <span th:text="${#temporals.format(destination.dateOfDeparture, 'dd-MM-yyyy')}"></span>
          </p>
          <p class="text-black-600 font-bold"> Дата на връщане:
            <span th:text="${#temporals.format(destination.dateOfReturn, 'dd-MM-yyyy')}"></span>
          </p>

          <!-- Image -->
          <img th:src="'/uploaded-image/' + ${destination.imageUrl}"
               alt="Destination Image"
               class="w-full h-40 object-cover rounded-lg mt-4">

          <!-- Other Info -->
          <p class="mt-2 text-black-600 font-bold"> Оставащи места: <span th:text="${destination.remainingPeople}"></span></p>
          <p class="text-yellow-500 font-bold">Цена:
            <span th:text="${#numbers.formatDecimal(destination.price, 2, 2)}"></span> лв.
          </p>
          <p class = "text-black-600 font-bold">⭐ <span th:text="${destination.getAverageRating()}"></span></p>
          <p class = "text-black-600 font-bold">Популярност: <span th:text="${destination.getPopularity()}"></span> резервирали</p>

          <!-- Closed Reservations Notice -->
          <th:block th:if="${destination.remainingPeople == 0 or destination.dateOfDeparture <= T(java.time.LocalDate).now()}">
            <p class="text-red-500 font-bold">Затворено за резервации</p>
          </th:block>

          <!-- Reserve Button (Always at Bottom) -->
          <div class="mt-auto pt-4">
            <div sec:authorize="hasAuthority('USER')">
              <th:block th:if="${destination.dateOfDeparture > T(java.time.LocalDate).now()}">
                <a th:href="@{/reservation/{id}(id=${destination.id})}">
                  <button class="btn btn-secondary w-full">Направи резервация</button>
                </a>
              </th:block>
            </div>
          </div>

        </div>
      </th:block>
    </th:block>
  </div>

</div>
<div class="mb-10"></div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    let departureInput = document.getElementById("startDate");
    let returnInput = document.getElementById("endDate");

    departureInput.addEventListener("change", function () {
      if (departureInput.value) {
        returnInput.min = departureInput.value; // Set return date min to departure date
      }
      if (returnInput.value && departureInput.value > returnInput.value) {
        alert("Датата на тръгване не може да бъде след датата на връщане!");
        departureInput.value = ""; // Reset invalid departure date
      }
    });

    returnInput.addEventListener("change", function () {
      if (departureInput.value && returnInput.value < departureInput.value) {
        alert("Датата на връщане трябва да бъде след датата на тръгване!");
        returnInput.value = ""; // Reset invalid return date
      }
    });
  });

  document.querySelector("#userMenu").addEventListener("click", () => {
    document.getElementById("dropdownMenu").classList.toggle("hidden");
  });

  document.addEventListener("DOMContentLoaded", function () {
    document.body.classList.remove("opacity-0");
  });
</script>
</body>
</html>
